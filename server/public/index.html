<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdCP Agent Registry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; min-height: 60vh; }

        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; border-bottom: 2px solid #ddd; margin-bottom: 2rem; }
        .tab { padding: 1rem 2rem; background: white; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 1rem; font-weight: 600; color: #666; transition: all 0.2s; }
        .tab:hover { color: #667eea; }
        .tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }

        /* Search and Filters */
        .search-filters { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-box { margin-bottom: 1rem; }
        .search-box input { width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; }
        .search-box input:focus { outline: none; border-color: #667eea; }
        .filter-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .filter-group label { font-weight: 600; font-size: 0.9rem; color: #666; }
        .filter-btn { padding: 0.5rem 1rem; background: #f9fafb; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .filter-btn:hover { border-color: #667eea; color: #667eea; }
        .filter-btn.active { background: #667eea; border-color: #667eea; color: white; }

        /* Agent Grid */
        .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .agent-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .agent-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .agent-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .agent-title { flex: 1; }
        .agent-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .agent-url { font-size: 0.85rem; color: #667eea; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-badge.online { background: #d1fae5; color: #065f46; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        .agent-meta { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #666; }
        .meta-value { font-weight: 600; color: #333; }
        .agent-properties { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; }
        .property-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .property-tag { padding: 0.25rem 0.75rem; background: #ede9fe; color: #5b21b6; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .formats-list { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .format-badge { padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

        /* Detail Page */
        .back-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 6px; text-decoration: none; font-weight: 600; margin-bottom: 2rem; }
        .back-btn:hover { background: #667eea; color: white; }
        .detail-hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem 0; }
        .detail-hero h2 { font-size: 2rem; margin-bottom: 0.5rem; }
        .detail-content { background: white; margin-top: -2rem; border-radius: 12px 12px 0 0; padding: 2rem; }
        .detail-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid #eee; }
        .detail-section:last-child { border-bottom: none; }
        .detail-section h3 { font-size: 1.3rem; margin-bottom: 1rem; color: #667eea; display: flex; align-items: center; gap: 0.5rem; }
        .tools-list, .publishers-grid { display: grid; gap: 1rem; }
        .tool-item, .publisher-item { background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #667eea; }
        .tool-name { font-weight: 600; font-family: 'Monaco', monospace; margin-bottom: 0.25rem; }
        .tool-description { font-size: 0.9rem; color: #666; }
        .publisher-domain { font-weight: 600; margin-bottom: 0.25rem; }
        .info-box { background: #f9fafb; padding: 1rem; border-radius: 6px; }
        .loading { text-align: center; padding: 3rem; color: #666; }
        .error-text { color: #ef4444; font-size: 0.9rem; }
        .view { display: none; }
        .view.active { display: block; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        footer { background: white; border-top: 2px solid #eee; padding: 2rem; margin-top: 3rem; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .footer-section h3 { font-size: 1.1rem; margin-bottom: 1rem; color: #667eea; }
        .mcp-box { background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #667eea; }
        .mcp-box code { background: #ede9fe; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: Monaco, monospace; font-size: 0.9rem; color: #5b21b6; }
        .mcp-url { background: #ede9fe; padding: 0.75rem; border-radius: 6px; margin: 0.75rem 0; font-family: Monaco, monospace; font-size: 0.95rem; word-break: break-all; color: #5b21b6; }
        .footer-links { text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee; color: #666; }
        .footer-links a { color: #667eea; text-decoration: none; margin: 0 1rem; }
        @media (max-width: 768px) { .footer-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <h1>AdCP Agent Registry</h1>
        <p class="subtitle">Discover agents for advertising automation</p>
    </header>

    <!-- List View -->
    <div id="list-view" class="view active">
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('sales')">üè¢ Sales Agents</button>
                <button class="tab" onclick="switchTab('creative')">üé® Creative Agents</button>
                <button class="tab" onclick="switchTab('signals')">üìä Signals Agents</button>
            </div>

            <!-- Sales Tab -->
            <div id="sales-tab" class="tab-content active">
                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" id="sales-search" placeholder="Search by publisher name, domain, or country..." onkeyup="filterSalesAgents()">
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <button class="filter-btn active" data-status="all" onclick="setSalesStatusFilter('all')">All</button>
                            <button class="filter-btn" data-status="online" onclick="setSalesStatusFilter('online')">Active</button>
                            <button class="filter-btn" data-status="offline" onclick="setSalesStatusFilter('offline')">Issues</button>
                        </div>
                        <div class="filter-group" id="sales-channel-filters" style="display: none;">
                            <label>Channel:</label>
                        </div>
                        <div class="filter-group" id="sales-country-filters" style="display: none;">
                            <label>Country:</label>
                        </div>
                    </div>
                </div>
                <div id="sales-agents" class="agent-grid"></div>
            </div>

            <!-- Creative Tab -->
            <div id="creative-tab" class="tab-content">
                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" id="creative-search" placeholder="Search by format dimensions (e.g., 300x250, native)..." onkeyup="filterCreativeAgents()">
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <button class="filter-btn active" data-status="all" onclick="setCreativeStatusFilter('all')">All</button>
                            <button class="filter-btn" data-status="online" onclick="setCreativeStatusFilter('online')">Active</button>
                            <button class="filter-btn" data-status="offline" onclick="setCreativeStatusFilter('offline')">Issues</button>
                        </div>
                        <div class="filter-group" id="creative-format-filters" style="display: none;">
                            <label>Format:</label>
                        </div>
                    </div>
                </div>
                <div id="creative-agents" class="agent-grid"></div>
            </div>

            <!-- Signals Tab -->
            <div id="signals-tab" class="tab-content">
                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" id="signals-search" placeholder="Search signals agents..." onkeyup="filterSignalsAgents()">
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <button class="filter-btn active" data-status="all" onclick="setSignalsStatusFilter('all')">All</button>
                            <button class="filter-btn" data-status="online" onclick="setSignalsStatusFilter('online')">Active</button>
                            <button class="filter-btn" data-status="offline" onclick="setSignalsStatusFilter('offline')">Issues</button>
                        </div>
                    </div>
                </div>
                <div id="signals-agents" class="agent-grid"></div>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detail-view" class="view">
        <div class="detail-hero">
            <div class="container">
                <a href="#" class="back-btn" onclick="navigateToList(); return false;">‚Üê Back to Agents</a>
                <h2 id="detail-name"></h2>
                <div id="detail-url" class="agent-url"></div>
            </div>
        </div>
        <div class="container">
            <div class="detail-content" id="detail-body"></div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>ü§ñ Use in Your AI Assistant</h3>
                <div class="mcp-box">
                    <p>Add this MCP server to Claude Desktop or ChatGPT:</p>
                    <div class="mcp-url">https://adcp-registry.fly.dev/mcp</div>
                    <p style="font-size: 0.9rem; color: #666;">Exposes 4 tools: <code>list_agents</code>, <code>get_agent</code>, <code>find_agents_for_property</code>, <code>get_properties_for_agent</code></p>
                </div>
            </div>
            <div class="footer-section">
                <h3>üìö Resources</h3>
                <p style="margin-bottom: 0.5rem;">Learn more about the Ad Context Protocol:</p>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin: 0.5rem 0;"><a href="https://adcontextprotocol.org" target="_blank" style="color: #667eea; text-decoration: none;">‚Üí AdCP Documentation</a></li>
                    <li style="margin: 0.5rem 0;"><a href="/api/agents" style="color: #667eea; text-decoration: none;">‚Üí REST API</a></li>
                    <li style="margin: 0.5rem 0;"><a href="https://github.com/adcontextprotocol" target="_blank" style="color: #667eea; text-decoration: none;">‚Üí GitHub</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-links">
            Powered by <a href="https://adcontextprotocol.org" target="_blank">Ad Context Protocol</a>
        </div>
    </footer>

    <script type="module">
        let salesAgents = [];
        let creativeAgents = [];
        let signalsAgents = [];
        let salesAgentsEnriched = []; // With properties data
        let creativeAgentsEnriched = []; // With formats data
        let currentTab = 'sales';
        let salesFilters = { status: 'all', channel: null, country: null, search: '' };
        let creativeFilters = { status: 'all', format: null, search: '' };
        let signalsFilters = { status: 'all', search: '' };

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            handleRoute();
            window.addEventListener('hashchange', handleRoute);
            await loadAllAgents();
        });

        async function loadAllAgents() {
            try {
                // Load all agents with health and properties in one call
                const response = await fetch('/api/agents?health=true&properties=true');
                const agents = await response.json();

                salesAgents = agents.filter(a => a.type === 'sales');
                creativeAgents = agents.filter(a => a.type === 'creative');
                signalsAgents = agents.filter(a => a.type === 'signals');

                // Sales agents already have properties from server
                // Mark agents as offline if they have property errors (missing required tool)
                salesAgentsEnriched = salesAgents.map(agent => {
                    const hasPropertyError = agent.propertiesError && agent.propertiesError.length > 0;
                    return {
                        ...agent,
                        properties: agent.properties || [],
                        propertiesError: agent.propertiesError,
                        health: hasPropertyError
                            ? { ...agent.health, online: false, error: `Missing required tool: ${agent.propertiesError}` }
                            : agent.health
                    };
                });
                buildSalesFilters();

                // Enrich creative agents with formats
                await enrichCreativeAgents();

                // Render current tab
                renderCurrentTab();
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }

        async function enrichCreativeAgents() {
            // For now, just use the agents as-is
            // TODO: Call list_creative_formats tool to get actual formats
            creativeAgentsEnriched = creativeAgents.map(agent => ({
                ...agent,
                formats: [] // Will be populated when agents implement the tool
            }));
        }

        function buildSalesFilters() {
            const channels = new Set();
            const countries = new Set();

            salesAgentsEnriched.forEach(agent => {
                agent.properties.forEach(prop => {
                    if (prop.tags) {
                        prop.tags.forEach(tag => {
                            if (tag.toLowerCase().includes('dooh') || tag.toLowerCase().includes('digital') ||
                                tag.toLowerCase().includes('mobile') || tag.toLowerCase().includes('ctv') ||
                                tag.toLowerCase().includes('web') || tag.toLowerCase().includes('display')) {
                                channels.add(tag);
                            }
                        });
                    }
                    if (prop.country) countries.add(prop.country);
                });
            });

            // Render channel filters
            const channelContainer = document.getElementById('sales-channel-filters');
            if (channels.size > 0) {
                channelContainer.style.display = 'flex';
                channels.forEach(channel => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = channel;
                    btn.onclick = () => setSalesChannelFilter(channel);
                    channelContainer.appendChild(btn);
                });
            }

            // Render country filters
            const countryContainer = document.getElementById('sales-country-filters');
            if (countries.size > 0) {
                countryContainer.style.display = 'flex';
                countries.forEach(country => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = country;
                    btn.onclick = () => setSalesCountryFilter(country);
                    countryContainer.appendChild(btn);
                });
            }
        }

        window.switchTab = function(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');

            renderCurrentTab();
        };

        function renderCurrentTab() {
            if (currentTab === 'sales') renderSalesAgents();
            else if (currentTab === 'creative') renderCreativeAgents();
            else if (currentTab === 'signals') renderSignalsAgents();
        }

        function renderSalesAgents() {
            const filtered = salesAgentsEnriched.filter(agent => {
                // Status filter
                if (salesFilters.status !== 'all') {
                    const online = agent.health?.online || false;
                    if (salesFilters.status === 'online' && !online) return false;
                    if (salesFilters.status === 'offline' && online) return false;
                }

                // Channel filter
                if (salesFilters.channel) {
                    const hasChannel = agent.properties.some(p =>
                        p.tags && p.tags.some(t => t === salesFilters.channel)
                    );
                    if (!hasChannel) return false;
                }

                // Country filter
                if (salesFilters.country) {
                    const hasCountry = agent.properties.some(p => p.country === salesFilters.country);
                    if (!hasCountry) return false;
                }

                // Search filter
                if (salesFilters.search) {
                    const query = salesFilters.search.toLowerCase();
                    const matchesName = agent.name.toLowerCase().includes(query);
                    const matchesProperty = agent.properties.some(p =>
                        (p.identifier && p.identifier.toLowerCase().includes(query)) ||
                        (p.domain && p.domain.toLowerCase().includes(query)) ||
                        (p.description && p.description.toLowerCase().includes(query)) ||
                        (p.country && p.country.toLowerCase().includes(query))
                    );
                    if (!matchesName && !matchesProperty) return false;
                }

                return true;
            });

            const container = document.getElementById('sales-agents');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No sales agents found matching your filters.</div>';
                return;
            }

            container.innerHTML = filtered.map(agent => `
                <div class="agent-card" onclick="navigateToAgent('${agent.type}/${agent.name.toLowerCase().replace(/\s+/g, '-')}')">
                    <div class="agent-header">
                        <div class="agent-title">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-url">${agent.url}</div>
                        </div>
                        <span class="status-badge ${agent.health?.online ? 'online' : 'offline'}">
                            ${agent.health?.online ? 'Active' : 'Issues'}
                        </span>
                    </div>

                    ${agent.description ? `<p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${agent.description}</p>` : ''}

                    <div class="agent-meta">
                        <div class="meta-item">
                            <span>üìä</span>
                            <span class="meta-value">${agent.properties.length}</span> properties
                        </div>
                        ${agent.health?.response_time_ms ? `
                        <div class="meta-item">
                            <span>‚ö°</span>
                            <span class="meta-value">${agent.health.response_time_ms}ms</span>
                        </div>
                        ` : ''}
                    </div>

                    ${agent.properties.length > 0 ? `
                    <div class="agent-properties">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                            <strong>Publishers:</strong> ${agent.properties.slice(0, 3).map(p => p.identifier || p.domain).join(', ')}${agent.properties.length > 3 ? ` +${agent.properties.length - 3} more` : ''}
                        </div>
                        <div class="property-tags">
                            ${Array.from(new Set(agent.properties.flatMap(p => p.tags || []))).slice(0, 5).map(tag =>
                                `<span class="property-tag">${tag}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : agent.propertiesError ? `
                    <div class="agent-properties">
                        <div style="font-size: 0.85rem; color: #e53e3e; padding: 0.5rem; background: #fff5f5; border-radius: 4px; border-left: 3px solid #e53e3e;">
                            <strong>‚ùå Tool Error:</strong><br>
                            <span style="font-size: 0.8rem; color: #991b1b; font-family: monospace; word-break: break-word;">${agent.propertiesError}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderCreativeAgents() {
            const filtered = creativeAgentsEnriched.filter(agent => {
                // Status filter
                if (creativeFilters.status !== 'all') {
                    const online = agent.health?.online || false;
                    if (creativeFilters.status === 'online' && !online) return false;
                    if (creativeFilters.status === 'offline' && online) return false;
                }

                // Search filter
                if (creativeFilters.search) {
                    const query = creativeFilters.search.toLowerCase();
                    const matchesName = agent.name.toLowerCase().includes(query);
                    const matchesFormat = agent.formats.some(f => f.toLowerCase().includes(query));
                    if (!matchesName && !matchesFormat) return false;
                }

                return true;
            });

            const container = document.getElementById('creative-agents');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No creative agents found matching your filters.</div>';
                return;
            }

            container.innerHTML = filtered.map(agent => `
                <div class="agent-card" onclick="navigateToAgent('${agent.type}/${agent.name.toLowerCase().replace(/\s+/g, '-')}')">
                    <div class="agent-header">
                        <div class="agent-title">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-url">${agent.url}</div>
                        </div>
                        <span class="status-badge ${agent.health?.online ? 'online' : 'offline'}">
                            ${agent.health?.online ? 'Active' : 'Issues'}
                        </span>
                    </div>

                    ${agent.description ? `<p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${agent.description}</p>` : ''}

                    <div class="agent-meta">
                        <div class="meta-item">
                            <span>üé®</span>
                            <span class="meta-value">${agent.formats.length || 'TBD'}</span> formats
                        </div>
                        ${agent.health?.response_time_ms ? `
                        <div class="meta-item">
                            <span>‚ö°</span>
                            <span class="meta-value">${agent.health.response_time_ms}ms</span>
                        </div>
                        ` : ''}
                    </div>

                    ${agent.formats.length > 0 ? `
                    <div class="formats-list">
                        ${agent.formats.slice(0, 5).map(format =>
                            `<span class="format-badge">${format}</span>`
                        ).join('')}
                        ${agent.formats.length > 5 ? `<span class="format-badge">+${agent.formats.length - 5} more</span>` : ''}
                    </div>
                    ` : `
                    <div style="margin-top: 1rem; font-size: 0.85rem; color: #999;">üìê Format discovery coming soon</div>
                    `}
                </div>
            `).join('');
        }

        function renderSignalsAgents() {
            const filtered = signalsAgents.filter(agent => {
                // Status filter
                if (signalsFilters.status !== 'all') {
                    const online = agent.health?.online || false;
                    if (signalsFilters.status === 'online' && !online) return false;
                    if (signalsFilters.status === 'offline' && online) return false;
                }

                // Search filter
                if (signalsFilters.search) {
                    const query = signalsFilters.search.toLowerCase();
                    if (!agent.name.toLowerCase().includes(query)) return false;
                }

                return true;
            });

            const container = document.getElementById('signals-agents');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No signals agents registered yet.</div>';
                return;
            }

            container.innerHTML = filtered.map(agent => `
                <div class="agent-card" onclick="navigateToAgent('${agent.type}/${agent.name.toLowerCase().replace(/\s+/g, '-')}')">
                    <div class="agent-header">
                        <div class="agent-title">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-url">${agent.url}</div>
                        </div>
                        <span class="status-badge ${agent.health?.online ? 'online' : 'offline'}">
                            ${agent.health?.online ? 'Active' : 'Issues'}
                        </span>
                    </div>

                    ${agent.description ? `<p style="color: #666; font-size: 0.9rem;">${agent.description}</p>` : ''}

                    <div class="agent-meta">
                        ${agent.health?.response_time_ms ? `
                        <div class="meta-item">
                            <span>‚ö°</span>
                            <span class="meta-value">${agent.health.response_time_ms}ms</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Filter functions for sales
        window.setSalesStatusFilter = function(status) {
            salesFilters.status = status;
            document.querySelectorAll('#sales-tab .filter-btn[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderSalesAgents();
        };

        window.setSalesChannelFilter = function(channel) {
            salesFilters.channel = salesFilters.channel === channel ? null : channel;
            document.querySelectorAll('#sales-channel-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === channel && salesFilters.channel);
            });
            renderSalesAgents();
        };

        window.setSalesCountryFilter = function(country) {
            salesFilters.country = salesFilters.country === country ? null : country;
            document.querySelectorAll('#sales-country-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === country && salesFilters.country);
            });
            renderSalesAgents();
        };

        window.filterSalesAgents = function() {
            salesFilters.search = document.getElementById('sales-search').value;
            renderSalesAgents();
        };

        // Filter functions for creative
        window.setCreativeStatusFilter = function(status) {
            creativeFilters.status = status;
            document.querySelectorAll('#creative-tab .filter-btn[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderCreativeAgents();
        };

        window.filterCreativeAgents = function() {
            creativeFilters.search = document.getElementById('creative-search').value;
            renderCreativeAgents();
        };

        // Filter functions for signals
        window.setSignalsStatusFilter = function(status) {
            signalsFilters.status = status;
            document.querySelectorAll('#signals-tab .filter-btn[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderSignalsAgents();
        };

        window.filterSignalsAgents = function() {
            signalsFilters.search = document.getElementById('signals-search').value;
            renderSignalsAgents();
        };

        // Navigation
        window.navigateToAgent = function(agentId) {
            window.location.hash = `#agent/${agentId}`;
        };

        window.navigateToList = function() {
            window.location.hash = '';
        };

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            if (hash.startsWith('agent/')) {
                const agentId = hash.replace('agent/', '');
                showAgentDetail(agentId);
            } else {
                showListView();
            }
        }

        function showListView() {
            document.getElementById('list-view').classList.add('active');
            document.getElementById('detail-view').classList.remove('active');
        }

        async function showAgentDetail(agentId) {
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('detail-view').classList.add('active');

            try {
                const [type, ...nameParts] = agentId.split('/');
                const name = nameParts.join('/');
                const response = await fetch(`/api/agents/${type}/${name}`);
                const agent = await response.json();

                document.getElementById('detail-name').textContent = agent.name;
                document.getElementById('detail-url').textContent = agent.url;

                let html = '';

                // Tools section
                const health = agent.health || {};
                if (health.tools_count > 0) {
                    html += `
                        <div class="detail-section">
                            <h3>üõ†Ô∏è Tools (${health.tools_count})</h3>
                            <div id="tools-section"><div class="loading">Loading tools...</div></div>
                        </div>
                    `;
                }

                // Type-specific sections
                if (agent.type === 'sales') {
                    html += `
                        <div class="detail-section">
                            <h3>üì∞ Publishers</h3>
                            <div id="publishers-section"><div class="loading">Loading publishers...</div></div>
                        </div>
                    `;
                } else if (agent.type === 'creative') {
                    html += `
                        <div class="detail-section">
                            <h3>üé® Creative Formats</h3>
                            <div id="formats-section"><div class="loading">Loading formats...</div></div>
                        </div>
                    `;
                }

                // Agent info
                html += `
                    <div class="detail-section">
                        <h3>‚ÑπÔ∏è Agent Information</h3>
                        <div class="info-box">
                            ${agent.description ? `<p style="margin-bottom: 1rem;">${agent.description}</p>` : ''}
                            <div style="margin-bottom: 0.5rem;"><strong>Type:</strong> ${agent.type}</div>
                            <div style="margin-bottom: 0.5rem;"><strong>Protocol:</strong> ${agent.protocol || 'mcp'}</div>
                            ${agent.mcp_endpoint ? `<div style="margin-bottom: 0.5rem;"><strong>Endpoint:</strong> <code style="background: #ede9fe; padding: 0.25rem 0.5rem; border-radius: 4px;">${agent.mcp_endpoint}</code></div>` : ''}
                            ${health.response_time_ms ? `<div style="margin-bottom: 0.5rem;"><strong>Response Time:</strong> ${health.response_time_ms}ms</div>` : ''}
                            ${agent.contact ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                                    <strong>Contact:</strong> ${agent.contact.name}<br>
                                    <a href="mailto:${agent.contact.email}" style="color: #667eea;">${agent.contact.email}</a>
                                    ${agent.contact.website ? ` | <a href="${agent.contact.website}" target="_blank" style="color: #667eea;">${agent.contact.website}</a>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                document.getElementById('detail-body').innerHTML = html;

                // Fetch additional data
                if (agent.type === 'sales') {
                    fetchPublishers(agent);
                } else if (agent.type === 'creative') {
                    fetchFormats(agent);
                }
            } catch (error) {
                document.getElementById('detail-body').innerHTML = `<div class="error-text">Failed to load agent details: ${error.message}</div>`;
            }
        }

        async function fetchPublishers(agent) {
            try {
                const response = await fetch(`/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'tools/call',
                        params: {
                            name: 'get_properties_for_agent',
                            arguments: { agent_url: agent.url }
                        }
                    })
                });
                const data = await response.json();
                const result = JSON.parse(data.result.content[0].resource.text);

                const section = document.getElementById('publishers-section');

                if (result.error) {
                    section.innerHTML = `<div style="color: #e53e3e; font-size: 0.9rem; padding: 0.75rem; background: #fff5f5; border-radius: 6px; border: 1px solid #feb2b2;">
                        <strong>Error:</strong> Agent does not support list_authorized_properties tool yet.
                    </div>`;
                    return;
                }

                if (result.properties && result.properties.length > 0) {
                    section.innerHTML = '<div class="publishers-grid">' +
                        result.properties.map(p => `
                            <div class="publisher-item">
                                <div class="publisher-domain">${p.identifier || p.domain || 'Unknown'}</div>
                                <div style="font-size: 0.85rem; color: #666;">${p.type || 'domain'}</div>
                                ${p.tags ? `<div style="margin-top: 0.5rem; font-size: 0.85rem;">Tags: ${p.tags.join(', ')}</div>` : ''}
                                ${p.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #555;">${p.description}</div>` : ''}
                            </div>
                        `).join('') +
                        '</div>';
                } else {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">No properties available from this agent yet.</div>`;
                }
            } catch (error) {
                document.getElementById('publishers-section').innerHTML = `<div class="error-text">Failed to load publishers: ${error.message}</div>`;
            }
        }

        async function fetchFormats(agent) {
            const section = document.getElementById('formats-section');
            section.innerHTML = '<div style="color: #666; font-size: 0.9rem;">Creative formats discovery coming soon...</div>';
        }
    </script>
</body>
</html>
