<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdCP Agent Registry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }

        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; border-bottom: 2px solid #ddd; margin-bottom: 2rem; }
        .tab { padding: 1rem 2rem; background: white; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 1rem; font-weight: 600; color: #666; transition: all 0.2s; }
        .tab:hover { color: #667eea; }
        .tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }

        /* Search and Filters */
        .search-filters { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-box { margin-bottom: 1rem; }
        .search-box input { width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; }
        .search-box input:focus { outline: none; border-color: #667eea; }
        .filter-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .filter-group label { font-weight: 600; font-size: 0.9rem; color: #666; }
        .filter-btn { padding: 0.5rem 1rem; background: #f9fafb; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .filter-btn:hover { border-color: #667eea; color: #667eea; }
        .filter-btn.active { background: #667eea; border-color: #667eea; color: white; }

        /* Agent Grid */
        .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .agent-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .agent-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .agent-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .agent-title { flex: 1; }
        .agent-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .agent-url { font-size: 0.85rem; color: #667eea; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-badge.online { background: #d1fae5; color: #065f46; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        .agent-meta { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #666; }
        .meta-value { font-weight: 600; color: #333; }
        .agent-properties { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; }
        .property-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .property-tag { padding: 0.25rem 0.75rem; background: #ede9fe; color: #5b21b6; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .formats-list { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .format-badge { padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

        /* Detail Page */
        .back-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 6px; text-decoration: none; font-weight: 600; margin-bottom: 2rem; }
        .back-btn:hover { background: #667eea; color: white; }
        .detail-hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem 0; }
        .detail-hero h2 { font-size: 2rem; margin-bottom: 0.5rem; }
        .detail-content { background: white; margin-top: -2rem; border-radius: 12px 12px 0 0; padding: 2rem; }
        .detail-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid #eee; }
        .detail-section:last-child { border-bottom: none; }
        .detail-section h3 { font-size: 1.3rem; margin-bottom: 1rem; color: #667eea; display: flex; align-items: center; gap: 0.5rem; }
        .tools-list, .publishers-grid { display: grid; gap: 1rem; }
        .tool-item, .publisher-item { background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #667eea; }
        .tool-name { font-weight: 600; font-family: 'Monaco', monospace; margin-bottom: 0.25rem; }
        .tool-description { font-size: 0.9rem; color: #666; }
        .publisher-domain { font-weight: 600; margin-bottom: 0.25rem; }
        .info-box { background: #f9fafb; padding: 1rem; border-radius: 6px; }
        .loading { text-align: center; padding: 3rem; color: #666; }
        .error-text { color: #ef4444; font-size: 0.9rem; }
        .view { display: none; }
        .view.active { display: block; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        footer { background: white; border-top: 2px solid #eee; padding: 2rem; margin-top: 3rem; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .footer-section h3 { font-size: 1.1rem; margin-bottom: 1rem; color: #667eea; }
        .mcp-box { background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #667eea; }
        .mcp-box code { background: #ede9fe; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: Monaco, monospace; font-size: 0.9rem; color: #5b21b6; }
        .mcp-url { background: #ede9fe; padding: 0.75rem; border-radius: 6px; margin: 0.75rem 0; font-family: Monaco, monospace; font-size: 0.95rem; word-break: break-all; color: #5b21b6; }
        .footer-links { text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee; color: #666; }
        .footer-links a { color: #667eea; text-decoration: none; margin: 0 1rem; }

        /* Collapsible details */
        details[open] summary span { transform: rotate(90deg); }
        details summary { user-select: none; }
        details summary::-webkit-details-marker { display: none; }

        @media (max-width: 768px) { .footer-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <h1>AdCP Agent Registry</h1>
        <p class="subtitle">Discover agents for advertising automation</p>
    </header>

    <!-- List View -->
    <div id="list-view" class="view active">
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('sales')">üè¢ Sales Agents</button>
                <button class="tab" onclick="switchTab('creative')">üé® Creative Agents</button>
                <button class="tab" onclick="switchTab('signals')">üìä Signals Agents</button>
            </div>

            <!-- Sales Tab -->
            <div id="sales-tab" class="tab-content active">
                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" id="sales-search" placeholder="Search by publisher name, domain, or country..." onkeyup="filterSalesAgents()">
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <button class="filter-btn active" data-status="all" onclick="setSalesStatusFilter('all')">All</button>
                            <button class="filter-btn" data-status="online" onclick="setSalesStatusFilter('online')">Active</button>
                            <button class="filter-btn" data-status="offline" onclick="setSalesStatusFilter('offline')">Issues</button>
                        </div>
                        <div class="filter-group" id="sales-channel-filters" style="display: none;">
                            <label>Channel:</label>
                        </div>
                        <div class="filter-group" id="sales-country-filters" style="display: none;">
                            <label>Country:</label>
                        </div>
                    </div>
                </div>
                <div id="sales-agents" class="agent-grid"></div>
            </div>

            <!-- Creative Tab -->
            <div id="creative-tab" class="tab-content">
                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" id="creative-search" placeholder="Search by format dimensions (e.g., 300x250, native)..." onkeyup="filterCreativeAgents()">
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <button class="filter-btn active" data-status="all" onclick="setCreativeStatusFilter('all')">All</button>
                            <button class="filter-btn" data-status="online" onclick="setCreativeStatusFilter('online')">Active</button>
                            <button class="filter-btn" data-status="offline" onclick="setCreativeStatusFilter('offline')">Issues</button>
                        </div>
                        <div class="filter-group" id="creative-format-filters" style="display: none;">
                            <label>Format:</label>
                        </div>
                    </div>
                </div>
                <div id="creative-agents" class="agent-grid"></div>
            </div>

            <!-- Signals Tab -->
            <div id="signals-tab" class="tab-content">
                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" id="signals-search" placeholder="Search signals agents..." onkeyup="filterSignalsAgents()">
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <button class="filter-btn active" data-status="all" onclick="setSignalsStatusFilter('all')">All</button>
                            <button class="filter-btn" data-status="online" onclick="setSignalsStatusFilter('online')">Active</button>
                            <button class="filter-btn" data-status="offline" onclick="setSignalsStatusFilter('offline')">Issues</button>
                        </div>
                    </div>
                </div>
                <div id="signals-agents" class="agent-grid"></div>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detail-view" class="view">
        <div class="detail-hero">
            <div class="container">
                <a href="#" class="back-btn" onclick="navigateToList(); return false;">‚Üê Back to Agents</a>
                <h2 id="detail-name"></h2>
                <div id="detail-url" class="agent-url"></div>
            </div>
        </div>
        <div class="container">
            <div class="detail-content" id="detail-body"></div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>ü§ñ Use in Your AI Assistant</h3>
                <div class="mcp-box">
                    <p>Add this MCP server to Claude Desktop or ChatGPT:</p>
                    <div class="mcp-url">https://adcp-registry.fly.dev/mcp</div>
                    <p style="font-size: 0.9rem; color: #666;">Exposes 4 tools: <code>list_agents</code>, <code>get_agent</code>, <code>find_agents_for_property</code>, <code>get_properties_for_agent</code></p>
                </div>
            </div>
            <div class="footer-section">
                <h3>üìö Resources</h3>
                <p style="margin-bottom: 0.5rem;">Learn more about the Ad Context Protocol:</p>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin: 0.5rem 0;"><a href="https://adcontextprotocol.org" target="_blank" style="color: #667eea; text-decoration: none;">‚Üí AdCP Documentation</a></li>
                    <li style="margin: 0.5rem 0;"><a href="/api/agents" style="color: #667eea; text-decoration: none;">‚Üí REST API</a></li>
                    <li style="margin: 0.5rem 0;"><a href="https://github.com/adcontextprotocol" target="_blank" style="color: #667eea; text-decoration: none;">‚Üí GitHub</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-links">
            Powered by <a href="https://adcontextprotocol.org" target="_blank">Ad Context Protocol</a>
        </div>
    </footer>

    <script type="module">
        let salesAgents = [];
        let creativeAgents = [];
        let signalsAgents = [];
        let salesAgentsEnriched = []; // With properties data
        let creativeAgentsEnriched = []; // With formats data
        let currentTab = 'sales';
        let salesFilters = { status: 'all', channel: null, country: null, search: '' };
        let creativeFilters = { status: 'all', format: null, search: '' };
        let signalsFilters = { status: 'all', search: '' };
        let isLoading = true;

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            handleRoute();
            window.addEventListener('hashchange', handleRoute);

            // Show loading skeletons immediately
            renderCurrentTab();

            await loadAllAgents();
        });

        async function loadAllAgents() {
            try {
                // Load all agents with health, properties, and capabilities in one call
                const response = await fetch('/api/agents?health=true&properties=true&capabilities=true');
                const agents = await response.json();

                salesAgents = agents.filter(a => a.type === 'sales');
                creativeAgents = agents.filter(a => a.type === 'creative');
                signalsAgents = agents.filter(a => a.type === 'signals');

                // Sales agents already have properties from server
                // Mark agents as offline if they have property errors (missing required tool)
                salesAgentsEnriched = salesAgents.map(agent => {
                    const hasPropertyError = agent.propertiesError && agent.propertiesError.length > 0;
                    return {
                        ...agent,
                        properties: agent.properties || [],
                        propertiesError: agent.propertiesError,
                        health: hasPropertyError
                            ? { ...agent.health, online: false, error: `Missing required tool: ${agent.propertiesError}` }
                            : agent.health
                    };
                });
                buildSalesFilters();

                // Enrich creative agents with formats
                await enrichCreativeAgents();

                // Done loading
                isLoading = false;

                // Render current tab
                renderCurrentTab();
            } catch (error) {
                console.error('Failed to load agents:', error);
                isLoading = false;
                renderCurrentTab();
            }
        }

        async function enrichCreativeAgents() {
            // Extract formats from capabilities if available
            creativeAgentsEnriched = creativeAgents.map(agent => ({
                ...agent,
                formats: agent.capabilities?.creative_capabilities?.formats_supported || []
            }));
        }

        function buildSalesFilters() {
            const channels = new Set();
            const countries = new Set();

            salesAgentsEnriched.forEach(agent => {
                agent.properties.forEach(prop => {
                    if (prop.tags) {
                        prop.tags.forEach(tag => {
                            if (tag.toLowerCase().includes('dooh') || tag.toLowerCase().includes('digital') ||
                                tag.toLowerCase().includes('mobile') || tag.toLowerCase().includes('ctv') ||
                                tag.toLowerCase().includes('web') || tag.toLowerCase().includes('display')) {
                                channels.add(tag);
                            }
                        });
                    }
                    if (prop.country) countries.add(prop.country);
                });
            });

            // Render channel filters
            const channelContainer = document.getElementById('sales-channel-filters');
            if (channels.size > 0) {
                channelContainer.style.display = 'flex';
                channels.forEach(channel => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = channel;
                    btn.onclick = () => setSalesChannelFilter(channel);
                    channelContainer.appendChild(btn);
                });
            }

            // Render country filters
            const countryContainer = document.getElementById('sales-country-filters');
            if (countries.size > 0) {
                countryContainer.style.display = 'flex';
                countries.forEach(country => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = country;
                    btn.onclick = () => setSalesCountryFilter(country);
                    countryContainer.appendChild(btn);
                });
            }
        }

        window.switchTab = function(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');

            renderCurrentTab();
        };

        function renderCurrentTab() {
            if (currentTab === 'sales') renderSalesAgents();
            else if (currentTab === 'creative') renderCreativeAgents();
            else if (currentTab === 'signals') renderSignalsAgents();
        }

        function renderLoadingSkeleton(count = 3) {
            return Array(count).fill(0).map(() => `
                <div class="agent-card" style="pointer-events: none; opacity: 0.6;">
                    <div class="agent-header">
                        <div class="agent-title" style="flex: 1;">
                            <div style="height: 20px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; width: 60%; margin-bottom: 0.5rem;"></div>
                            <div style="height: 14px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; width: 80%;"></div>
                        </div>
                        <span class="status-badge" style="background: #f0f0f0; color: transparent;">...</span>
                    </div>
                    <div style="height: 40px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; margin-bottom: 1rem;"></div>
                    <div class="agent-meta">
                        <div style="height: 16px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; width: 100px;"></div>
                    </div>
                </div>
            `).join('') + `
            <style>
                @keyframes shimmer {
                    0% { background-position: -200% 0; }
                    100% { background-position: 200% 0; }
                }
            </style>
            `;
        }

        function renderSalesAgents() {
            const container = document.getElementById('sales-agents');

            // Show loading skeleton while data is being fetched
            if (isLoading) {
                container.innerHTML = renderLoadingSkeleton(4);
                return;
            }

            const filtered = salesAgentsEnriched.filter(agent => {
                // Status filter
                if (salesFilters.status !== 'all') {
                    const online = agent.health?.online || false;
                    if (salesFilters.status === 'online' && !online) return false;
                    if (salesFilters.status === 'offline' && online) return false;
                }

                // Channel filter
                if (salesFilters.channel) {
                    const hasChannel = agent.properties.some(p =>
                        p.tags && p.tags.some(t => t === salesFilters.channel)
                    );
                    if (!hasChannel) return false;
                }

                // Country filter
                if (salesFilters.country) {
                    const hasCountry = agent.properties.some(p => p.country === salesFilters.country);
                    if (!hasCountry) return false;
                }

                // Search filter
                if (salesFilters.search) {
                    const query = salesFilters.search.toLowerCase();
                    const matchesName = agent.name.toLowerCase().includes(query);
                    const matchesProperty = agent.properties.some(p =>
                        (p.identifier && p.identifier.toLowerCase().includes(query)) ||
                        (p.domain && p.domain.toLowerCase().includes(query)) ||
                        (p.description && p.description.toLowerCase().includes(query)) ||
                        (p.country && p.country.toLowerCase().includes(query))
                    );
                    if (!matchesName && !matchesProperty) return false;
                }

                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No sales agents found matching your filters.</div>';
                return;
            }

            container.innerHTML = filtered.map(agent => `
                <div class="agent-card" onclick="navigateToAgent('${agent.type}/${agent.name.toLowerCase().replace(/\s+/g, '-')}')">
                    <div class="agent-header">
                        <div class="agent-title">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-url">${agent.url}</div>
                        </div>
                        <span class="status-badge ${agent.health?.online ? 'online' : 'offline'}">
                            ${agent.health?.online ? 'Active' : 'Issues'}
                        </span>
                    </div>

                    ${agent.description ? `<p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${agent.description}</p>` : ''}

                    <div class="agent-meta">
                        <div class="meta-item">
                            <span>üìä</span>
                            <span class="meta-value">${agent.properties.length}</span> properties
                        </div>
                        ${agent.health?.response_time_ms ? `
                        <div class="meta-item">
                            <span>‚ö°</span>
                            <span class="meta-value">${agent.health.response_time_ms}ms</span>
                        </div>
                        ` : ''}
                    </div>

                    ${agent.properties.length > 0 ? `
                    <div class="agent-properties">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                            <strong>Publishers:</strong> ${agent.properties.slice(0, 3).map(p => p.identifier || p.domain).join(', ')}${agent.properties.length > 3 ? ` +${agent.properties.length - 3} more` : ''}
                        </div>
                        <div class="property-tags">
                            ${Array.from(new Set(agent.properties.flatMap(p => p.tags || []))).slice(0, 5).map(tag =>
                                `<span class="property-tag">${tag}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : agent.propertiesError ? `
                    <div class="agent-properties">
                        <div style="font-size: 0.85rem; color: #e53e3e; padding: 0.5rem; background: #fff5f5; border-radius: 4px; border-left: 3px solid #e53e3e;">
                            <strong>‚ùå Tool Error:</strong><br>
                            <span style="font-size: 0.8rem; color: #991b1b; font-family: monospace; word-break: break-word;">${agent.propertiesError}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderCreativeAgents() {
            const container = document.getElementById('creative-agents');

            // Show loading skeleton while data is being fetched
            if (isLoading) {
                container.innerHTML = renderLoadingSkeleton(3);
                return;
            }

            const filtered = creativeAgentsEnriched.filter(agent => {
                // Status filter
                if (creativeFilters.status !== 'all') {
                    const online = agent.health?.online || false;
                    if (creativeFilters.status === 'online' && !online) return false;
                    if (creativeFilters.status === 'offline' && online) return false;
                }

                // Search filter
                if (creativeFilters.search) {
                    const query = creativeFilters.search.toLowerCase();
                    const matchesName = agent.name.toLowerCase().includes(query);
                    const matchesFormat = agent.formats.some(f => f.toLowerCase().includes(query));
                    if (!matchesName && !matchesFormat) return false;
                }

                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No creative agents found matching your filters.</div>';
                return;
            }

            container.innerHTML = filtered.map(agent => `
                <div class="agent-card" onclick="navigateToAgent('${agent.type}/${agent.name.toLowerCase().replace(/\s+/g, '-')}')">
                    <div class="agent-header">
                        <div class="agent-title">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-url">${agent.url}</div>
                        </div>
                        <span class="status-badge ${agent.health?.online ? 'online' : 'offline'}">
                            ${agent.health?.online ? 'Active' : 'Issues'}
                        </span>
                    </div>

                    ${agent.description ? `<p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${agent.description}</p>` : ''}

                    <div class="agent-meta">
                        <div class="meta-item">
                            <span>üé®</span>
                            <span class="meta-value">${agent.formats.length || 'TBD'}</span> formats
                        </div>
                        ${agent.health?.response_time_ms ? `
                        <div class="meta-item">
                            <span>‚ö°</span>
                            <span class="meta-value">${agent.health.response_time_ms}ms</span>
                        </div>
                        ` : ''}
                    </div>

                    ${agent.formats.length > 0 ? `
                    <div class="formats-list">
                        ${agent.formats.slice(0, 5).map(format =>
                            `<span class="format-badge">${format}</span>`
                        ).join('')}
                        ${agent.formats.length > 5 ? `<span class="format-badge">+${agent.formats.length - 5} more</span>` : ''}
                    </div>
                    ` : `
                    <div style="margin-top: 1rem; font-size: 0.85rem; color: #999;">üìê Format discovery coming soon</div>
                    `}
                </div>
            `).join('');
        }

        function renderSignalsAgents() {
            const container = document.getElementById('signals-agents');

            // Show loading skeleton while data is being fetched
            if (isLoading) {
                container.innerHTML = renderLoadingSkeleton(2);
                return;
            }

            const filtered = signalsAgents.filter(agent => {
                // Status filter
                if (signalsFilters.status !== 'all') {
                    const online = agent.health?.online || false;
                    if (signalsFilters.status === 'online' && !online) return false;
                    if (signalsFilters.status === 'offline' && online) return false;
                }

                // Search filter
                if (signalsFilters.search) {
                    const query = signalsFilters.search.toLowerCase();
                    if (!agent.name.toLowerCase().includes(query)) return false;
                }

                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No signals agents registered yet.</div>';
                return;
            }

            container.innerHTML = filtered.map(agent => `
                <div class="agent-card" onclick="navigateToAgent('${agent.type}/${agent.name.toLowerCase().replace(/\s+/g, '-')}')">
                    <div class="agent-header">
                        <div class="agent-title">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-url">${agent.url}</div>
                        </div>
                        <span class="status-badge ${agent.health?.online ? 'online' : 'offline'}">
                            ${agent.health?.online ? 'Active' : 'Issues'}
                        </span>
                    </div>

                    ${agent.description ? `<p style="color: #666; font-size: 0.9rem;">${agent.description}</p>` : ''}

                    <div class="agent-meta">
                        ${agent.health?.response_time_ms ? `
                        <div class="meta-item">
                            <span>‚ö°</span>
                            <span class="meta-value">${agent.health.response_time_ms}ms</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Filter functions for sales
        window.setSalesStatusFilter = function(status) {
            salesFilters.status = status;
            document.querySelectorAll('#sales-tab .filter-btn[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderSalesAgents();
        };

        window.setSalesChannelFilter = function(channel) {
            salesFilters.channel = salesFilters.channel === channel ? null : channel;
            document.querySelectorAll('#sales-channel-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === channel && salesFilters.channel);
            });
            renderSalesAgents();
        };

        window.setSalesCountryFilter = function(country) {
            salesFilters.country = salesFilters.country === country ? null : country;
            document.querySelectorAll('#sales-country-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === country && salesFilters.country);
            });
            renderSalesAgents();
        };

        window.filterSalesAgents = function() {
            salesFilters.search = document.getElementById('sales-search').value;
            renderSalesAgents();
        };

        // Filter functions for creative
        window.setCreativeStatusFilter = function(status) {
            creativeFilters.status = status;
            document.querySelectorAll('#creative-tab .filter-btn[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderCreativeAgents();
        };

        window.filterCreativeAgents = function() {
            creativeFilters.search = document.getElementById('creative-search').value;
            renderCreativeAgents();
        };

        // Filter functions for signals
        window.setSignalsStatusFilter = function(status) {
            signalsFilters.status = status;
            document.querySelectorAll('#signals-tab .filter-btn[data-status]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            renderSignalsAgents();
        };

        window.filterSignalsAgents = function() {
            signalsFilters.search = document.getElementById('signals-search').value;
            renderSignalsAgents();
        };

        // Navigation
        window.navigateToAgent = function(agentId) {
            window.location.hash = `#agent/${agentId}`;
        };

        window.navigateToList = function() {
            window.location.hash = '';
        };

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            if (hash.startsWith('agent/')) {
                const agentId = hash.replace('agent/', '');
                showAgentDetail(agentId);
            } else {
                showListView();
            }
        }

        function showListView() {
            document.getElementById('list-view').classList.add('active');
            document.getElementById('detail-view').classList.remove('active');
        }

        async function showAgentDetail(agentId) {
            document.getElementById('list-view').classList.remove('active');
            document.getElementById('detail-view').classList.add('active');

            try {
                const [type, ...nameParts] = agentId.split('/');
                const name = nameParts.join('/');

                // Fetch agent with health check
                const [agentResp, capsResp] = await Promise.all([
                    fetch(`/api/agents/${type}/${name}?health=true`),
                    fetch(`/api/agents?health=true&capabilities=true&properties=true`)
                ]);

                const agent = await agentResp.json();
                const allAgents = await capsResp.json();
                const agentWithCaps = allAgents.find(a => a.url === agent.url) || agent;

                document.getElementById('detail-name').textContent = agent.name;
                document.getElementById('detail-url').textContent = agent.url;

                let html = '';

                // Health status banner
                const health = agent.health || {};
                const statusColor = health.online ? '#10b981' : '#ef4444';
                const statusText = health.online ? 'Active' : 'Offline';
                html += `
                    <div style="background: ${statusColor}; color: white; padding: 1rem; border-radius: 6px; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1rem;">Status: ${statusText}</strong>
                            ${health.response_time_ms ? `<span style="margin-left: 1rem; opacity: 0.9;">Response time: ${health.response_time_ms}ms</span>` : ''}
                        </div>
                        ${health.last_check ? `<div style="opacity: 0.9; font-size: 0.9rem;">Last check: ${new Date(health.last_check).toLocaleString()}</div>` : ''}
                    </div>
                `;

                // Spec Compliance Badge
                if (agentWithCaps.capabilities) {
                    const caps = agentWithCaps.capabilities;

                    if (agent.type === 'sales' && caps.tools) {
                        // Check for actual AdCP spec required tools (from @adcp/client types)
                        const toolNames = new Set(caps.tools.map(t => t.name.toLowerCase()));
                        const requiredTools = [
                            'get_products',
                            'create_media_buy',
                            'update_media_buy',
                            'get_media_buy_delivery',
                            'sync_creatives',
                            'list_authorized_properties'
                        ];
                        const implementedTools = requiredTools.filter(tool => toolNames.has(tool));
                        const isCompliant = implementedTools.length === requiredTools.length;

                        html += `
                            <div style="background: ${isCompliant ? '#f0fdf4' : '#fff7ed'}; border-left: 4px solid ${isCompliant ? '#10b981' : '#f59e0b'}; padding: 1rem; border-radius: 6px; margin-bottom: 2rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.5rem;">${isCompliant ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                    <div>
                                        <strong style="font-size: 1.1rem;">${isCompliant ? 'AdCP Sales Agent' : 'Incomplete Implementation'}</strong>
                                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                            Implements ${implementedTools.length} of ${requiredTools.length} required tools: ${requiredTools.join(', ')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (agent.type === 'creative' && caps.creative_capabilities) {
                        const cc = caps.creative_capabilities;
                        // Only list_creative_formats is required per AdCP spec
                        const isCompliant = cc.formats_supported.length > 0;
                        const hasOptionalBuild = cc.can_generate;
                        const hasOptionalPreview = cc.can_preview;

                        const capabilities = [];
                        if (hasOptionalBuild) capabilities.push('Generate');
                        if (hasOptionalPreview) capabilities.push('Preview');

                        html += `
                            <div style="background: ${isCompliant ? '#f0fdf4' : '#fff7ed'}; border-left: 4px solid ${isCompliant ? '#10b981' : '#f59e0b'}; padding: 1rem; border-radius: 6px; margin-bottom: 2rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-size: 1.5rem;">${isCompliant ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                    <div>
                                        <strong style="font-size: 1.1rem;">${isCompliant ? 'AdCP Creative Agent' : 'Incomplete Implementation'}</strong>
                                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                            ${isCompliant ?
                                                `${cc.formats_supported.length} format(s)${capabilities.length > 0 ? ' ‚Ä¢ ' + capabilities.join(' ‚Ä¢ ') : ' ‚Ä¢ Formats only'}` :
                                                'Missing required list_creative_formats tool'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                // Type-specific sections (MOVED TO TOP)
                if (agent.type === 'sales') {
                    html += `
                        <div class="detail-section">
                            <h3>üì∞ Publishers & Properties</h3>
                            <div id="publishers-section"><div class="loading">Loading publishers...</div></div>
                        </div>
                        <div class="detail-section">
                            <details style="cursor: pointer;">
                                <summary style="font-size: 1.3rem; font-weight: 600; color: #667eea; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="transition: transform 0.2s;">‚ñ∂</span>
                                    üì¶ Public Products
                                </summary>
                                <div id="products-section" style="margin-top: 1rem;"><div class="loading">Click to load available products...</div></div>
                            </details>
                        </div>
                        <div class="detail-section">
                            <details style="cursor: pointer;">
                                <summary style="font-size: 1.3rem; font-weight: 600; color: #667eea; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="transition: transform 0.2s;">‚ñ∂</span>
                                    üé® Creative Formats
                                </summary>
                                <div id="creative-formats-section" style="margin-top: 1rem;"><div class="loading">Click to load supported formats...</div></div>
                            </details>
                        </div>
                    `;
                } else if (agent.type === 'creative') {
                    html += `
                        <div class="detail-section">
                            <h3>üé® Creative Formats</h3>
                            <div id="formats-section"><div class="loading">Loading formats...</div></div>
                        </div>
                    `;
                }

                // Tools section (moved to bottom, collapsible)
                html += `
                    <div class="detail-section">
                        <details style="cursor: pointer;">
                            <summary style="font-size: 1.3rem; font-weight: 600; color: #667eea; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="transition: transform 0.2s;">‚ñ∂</span>
                                üõ†Ô∏è Tools (${agentWithCaps.capabilities?.tools_count || 0})
                            </summary>
                            <div id="tools-section" style="margin-top: 1rem;"><div class="loading">Loading tools...</div></div>
                        </details>
                    </div>
                `;

                // Agent info
                html += `
                    <div class="detail-section">
                        <h3>‚ÑπÔ∏è Agent Information</h3>
                        <div class="info-box">
                            ${agent.description ? `<p style="margin-bottom: 1rem; font-size: 1.05rem;">${agent.description}</p>` : ''}
                            <div style="display: grid; gap: 0.75rem;">
                                <div><strong>Type:</strong> <span style="text-transform: capitalize;">${agent.type}</span></div>
                                <div><strong>Protocol:</strong> ${agent.protocol || 'mcp'}</div>
                                <div><strong>Endpoint:</strong> <code style="background: #ede9fe; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem; word-break: break-all;">${agent.url}</code></div>
                                ${agent.mcp_endpoint ? `<div><strong>MCP Endpoint:</strong> <code style="background: #ede9fe; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem; word-break: break-all;">${agent.mcp_endpoint}</code></div>` : ''}
                            </div>
                            ${agent.contact ? `
                                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
                                    <strong>Contact Information</strong><br>
                                    <div style="margin-top: 0.5rem;">
                                        ${agent.contact.name}<br>
                                        <a href="mailto:${agent.contact.email}" style="color: #667eea;">${agent.contact.email}</a>
                                        ${agent.contact.website ? `<br><a href="${agent.contact.website}" target="_blank" style="color: #667eea;">${agent.contact.website}</a>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                document.getElementById('detail-body').innerHTML = html;

                // Fetch tools and additional data
                fetchTools(agent);
                if (agent.type === 'sales') {
                    fetchPublishers(agent);

                    // Add event listeners for lazy-loaded sections
                    const productsDetails = document.querySelector('#products-section').closest('details');
                    const creativeFormatsDetails = document.querySelector('#creative-formats-section').closest('details');

                    productsDetails.addEventListener('toggle', function() {
                        if (this.open && document.getElementById('products-section').innerHTML.includes('Click to load')) {
                            fetchPublicProducts(agent);
                        }
                    });

                    creativeFormatsDetails.addEventListener('toggle', function() {
                        if (this.open && document.getElementById('creative-formats-section').innerHTML.includes('Click to load')) {
                            fetchCreativeFormats(agent);
                        }
                    });
                } else if (agent.type === 'creative') {
                    fetchFormats(agent);
                }
            } catch (error) {
                document.getElementById('detail-body').innerHTML = `<div class="error-text">Failed to load agent details: ${error.message}</div>`;
            }
        }

        async function fetchTools(agent) {
            const section = document.getElementById('tools-section');
            try {
                // Fetch capability discovery which includes all tools
                const response = await fetch(`/api/agents?health=true&capabilities=true`);
                const allAgents = await response.json();
                const agentWithCaps = allAgents.find(a => a.url === agent.url);

                if (!agentWithCaps || !agentWithCaps.capabilities || agentWithCaps.capabilities.tools_count === 0) {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">No tools discovered yet.</div>`;
                    return;
                }

                const tools = agentWithCaps.capabilities.tools || [];

                if (tools.length === 0) {
                    section.innerHTML = `
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; border-left: 3px solid #0284c7;">
                            <strong>Total Tools: ${agentWithCaps.capabilities.tools_count}</strong>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">This agent exposes ${agentWithCaps.capabilities.tools_count} tools via ${agent.protocol || 'mcp'} protocol.</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; border-left: 3px solid #0284c7; margin-bottom: 1.5rem;">
                        <strong>Total Tools: ${tools.length}</strong>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">This agent exposes ${tools.length} tools via ${agent.protocol || 'mcp'} protocol.</p>
                    </div>
                    <div class="tools-list">
                `;

                tools.forEach((tool, index) => {
                    const hasSchema = tool.input_schema && Object.keys(tool.input_schema).length > 0;
                    html += `
                        <div class="tool-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div class="tool-name">${index + 1}. ${tool.name}</div>
                                ${hasSchema ? `<details style="font-size: 0.75rem; color: #667eea; cursor: pointer;">
                                    <summary>Schema</summary>
                                    <pre style="margin-top: 0.5rem; background: #f9fafb; padding: 0.5rem; border-radius: 4px; overflow-x: auto; font-size: 0.7rem; max-height: 200px;">${JSON.stringify(tool.input_schema, null, 2)}</pre>
                                </details>` : ''}
                            </div>
                            ${tool.description ? `<div class="tool-description">${tool.description}</div>` : '<div class="tool-description" style="color: #999;">No description available</div>'}
                        </div>
                    `;
                });

                html += '</div>';
                section.innerHTML = html;
            } catch (error) {
                section.innerHTML = `<div class="error-text">Failed to load tools: ${error.message}</div>`;
            }
        }

        async function fetchPublishers(agent) {
            try {
                const response = await fetch(`/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'tools/call',
                        params: {
                            name: 'get_properties_for_agent',
                            arguments: { agent_url: agent.url }
                        }
                    })
                });
                const data = await response.json();
                const result = JSON.parse(data.result.content[0].resource.text);

                const section = document.getElementById('publishers-section');

                if (result.error) {
                    section.innerHTML = `<div style="color: #e53e3e; font-size: 0.9rem; padding: 0.75rem; background: #fff5f5; border-radius: 6px; border: 1px solid #feb2b2;">
                        <strong>Error:</strong> ${result.error}
                    </div>`;
                    return;
                }

                if (result.properties && result.properties.length > 0) {
                    // Group by verification status
                    const verified = result.properties.filter(p => p.verified === true);
                    const unverified = result.properties.filter(p => p.verified === false);
                    const unchecked = result.properties.filter(p => p.verified === undefined);

                    let html = '';

                    if (verified.length > 0) {
                        html += '<div style="margin-bottom: 1.5rem;">';
                        html += '<h4 style="font-size: 1rem; margin-bottom: 1rem; color: #10b981;">‚úì Verified Properties</h4>';
                        html += '<div class="publishers-grid">' +
                            verified.map(p => `
                                <div class="publisher-item" style="border-left: 3px solid #10b981;">
                                    <div style="display: flex; justify-content: between; align-items: start; gap: 0.5rem;">
                                        <div style="flex: 1;">
                                            <div class="publisher-domain">${p.identifier || p.domain || 'Unknown'}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                                <strong>Type:</strong> ${p.type || 'domain'}
                                                ${p.country ? ` | <strong>Country:</strong> ${p.country}` : ''}
                                            </div>
                                        </div>
                                        <a href="${p.verification_url}" target="_blank" style="color: #10b981; text-decoration: none; font-size: 0.85rem; white-space: nowrap;" title="View adagents.json">
                                            üîó Verified
                                        </a>
                                    </div>
                                    ${p.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #555;">${p.description}</div>` : ''}
                                    ${p.tags && p.tags.length > 0 ? `
                                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            ${p.tags.map(tag => `<span style="padding: 0.25rem 0.5rem; background: #ede9fe; color: #5b21b6; border-radius: 4px; font-size: 0.75rem;">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    ${p.metadata ? `<details style="margin-top: 0.75rem; font-size: 0.85rem;">
                                        <summary style="cursor: pointer; color: #667eea;">Additional metadata</summary>
                                        <pre style="margin-top: 0.5rem; background: #f9fafb; padding: 0.5rem; border-radius: 4px; overflow-x: auto;">${JSON.stringify(p.metadata, null, 2)}</pre>
                                    </details>` : ''}
                                </div>
                            `).join('') +
                        '</div>';
                        html += '</div>';
                    }

                    if (unverified.length > 0) {
                        html += '<div style="margin-bottom: 1.5rem;">';
                        html += '<h4 style="font-size: 1rem; margin-bottom: 1rem; color: #ef4444;">‚úó Unverified Properties (Claims Not Authorized)</h4>';
                        html += '<div class="publishers-grid">' +
                            unverified.map(p => `
                                <div class="publisher-item" style="border-left: 3px solid #ef4444; background: #fff5f5;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                                        <div style="flex: 1;">
                                            <div class="publisher-domain">${p.identifier || p.domain || 'Unknown'}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">${p.type || 'domain'}</div>
                                        </div>
                                        ${p.verification_url ? `<a href="${p.verification_url}" target="_blank" style="color: #ef4444; text-decoration: none; font-size: 0.85rem; white-space: nowrap;" title="Check adagents.json">
                                            üîó Check
                                        </a>` : ''}
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #991b1b; background: #fee2e2; padding: 0.5rem; border-radius: 4px;">
                                        <strong>‚ö†Ô∏è Warning:</strong> ${p.verification_error || 'This agent is not listed in the domain\'s .well-known/adagents.json file'}
                                    </div>
                                </div>
                            `).join('') +
                        '</div>';
                        html += '</div>';
                    }

                    if (unchecked.length > 0) {
                        html += '<div>';
                        html += '<h4 style="font-size: 1rem; margin-bottom: 1rem; color: #f59e0b;">‚ö†Ô∏è Unchecked Properties</h4>';
                        html += '<div class="publishers-grid">' +
                            unchecked.map(p => `
                                <div class="publisher-item" style="border-left: 3px solid #f59e0b;">
                                    <div class="publisher-domain">${p.identifier || p.domain || 'Unknown'}</div>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">${p.type || 'domain'}</div>
                                </div>
                            `).join('') +
                        '</div>';
                        html += '</div>';
                    }

                    section.innerHTML = html;
                } else {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">No properties available from this agent yet.</div>`;
                }
            } catch (error) {
                document.getElementById('publishers-section').innerHTML = `<div class="error-text">Failed to load publishers: ${error.message}</div>`;
            }
        }

        async function fetchFormats(agent) {
            const section = document.getElementById('formats-section');
            section.innerHTML = '<div class="loading">Loading formats...</div>';

            try {
                const response = await fetch(`/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'tools/call',
                        params: {
                            name: 'list_creative_formats_for_agent',
                            arguments: { agent_url: agent.url, params: {} }
                        }
                    })
                });
                const data = await response.json();

                if (data.error) {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">Unable to fetch formats: ${data.error.message || 'Unknown error'}</div>`;
                    return;
                }

                const result = JSON.parse(data.result.content[0].resource.text);

                if (result.error) {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">${result.error}</div>`;
                    return;
                }

                // Handle different response formats
                let formats = [];
                if (Array.isArray(result)) {
                    formats = result;
                } else if (result.formats && Array.isArray(result.formats)) {
                    formats = result.formats;
                } else if (result.data && Array.isArray(result.data)) {
                    formats = result.data;
                } else if (result.data && result.data.formats) {
                    formats = result.data.formats;
                }

                if (formats.length === 0) {
                    section.innerHTML = '<div style="color: #666; font-size: 0.9rem;">No creative formats available</div>';
                    return;
                }

                // Display formats in a grid
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">';
                formats.forEach(format => {
                    const formatName = typeof format === 'string' ? format : (format.name || format.format || 'Unknown');
                    const dimensions = typeof format === 'object' ? (format.dimensions || format.size) : null;
                    const type = typeof format === 'object' ? (format.type || format.format_type) : null;
                    const description = typeof format === 'object' ? format.description : null;

                    html += `
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${formatName}</div>
                            ${dimensions ? `<div style="font-size: 0.85rem; color: #666;">üìê ${dimensions}</div>` : ''}
                            ${type ? `<div style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem; text-transform: capitalize;">${type}</div>` : ''}
                            ${description ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${description}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';

                section.innerHTML = html;
            } catch (error) {
                section.innerHTML = `<div class="error-text">Failed to load formats: ${error.message}</div>`;
            }
        }

        async function fetchPublicProducts(agent) {
            const section = document.getElementById('products-section');
            section.innerHTML = '<div class="loading">Loading products...</div>';

            try {
                const response = await fetch(`/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'tools/call',
                        params: {
                            name: 'get_products_for_agent',
                            arguments: { agent_url: agent.url, params: {} }
                        }
                    })
                });
                const data = await response.json();

                if (data.error) {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">Unable to fetch products: ${data.error.message || 'Unknown error'}</div>`;
                    return;
                }

                const result = JSON.parse(data.result.content[0].resource.text);

                if (result.error) {
                    const isValidationError = result.error.includes('does not match') || result.error.includes('Input should be');
                    section.innerHTML = `
                        <div style="background: #fff7ed; padding: 1rem; border-radius: 6px; border-left: 3px solid #f59e0b;">
                            <strong>${isValidationError ? 'Agent Requires Parameters' : 'Agent Error'}</strong>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                ${isValidationError ? 'This agent requires specific targeting criteria (brief, brand_manifest, etc.) and does not support browsing public products.' : result.error}
                            </div>
                        </div>
                    `;
                    return;
                }

                const products = result.products || [];

                if (products.length === 0) {
                    section.innerHTML = '<div style="color: #666; font-size: 0.9rem;">No public products available (may require targeting)</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 1rem;">';
                products.forEach(product => {
                    html += `
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${product.name || product.id || 'Unnamed Product'}</div>
                            ${product.description ? `<div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">${product.description}</div>` : ''}
                            ${product.inventory_type ? `<div style="font-size: 0.85rem; color: #666;"><strong>Type:</strong> ${product.inventory_type}</div>` : ''}
                            ${product.price ? `<div style="font-size: 0.85rem; color: #666;"><strong>Price:</strong> ${product.price.amount} ${product.price.currency}</div>` : ''}
                            ${product.publisher_domain ? `<div style="font-size: 0.85rem; color: #666;"><strong>Publisher:</strong> ${product.publisher_domain}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';

                section.innerHTML = html;
            } catch (error) {
                section.innerHTML = `<div class="error-text">Failed to load products: ${error.message}</div>`;
            }
        }

        async function fetchCreativeFormats(agent) {
            const section = document.getElementById('creative-formats-section');
            section.innerHTML = '<div class="loading">Loading formats...</div>';

            try {
                const response = await fetch(`/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'tools/call',
                        params: {
                            name: 'list_creative_formats_for_agent',
                            arguments: { agent_url: agent.url, params: {} }
                        }
                    })
                });
                const data = await response.json();

                if (data.error) {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">Unable to fetch formats: ${data.error.message || 'Unknown error'}</div>`;
                    return;
                }

                const result = JSON.parse(data.result.content[0].resource.text);

                if (result.error) {
                    section.innerHTML = `<div style="color: #666; font-size: 0.9rem;">${result.error}</div>`;
                    return;
                }

                const formats = result.formats || [];

                if (formats.length === 0) {
                    section.innerHTML = '<div style="color: #666; font-size: 0.9rem;">No creative formats available</div>';
                    return;
                }

                // Extract unique types for filtering
                const types = [...new Set(formats.map(f => f.type).filter(Boolean))];

                let html = `
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <strong style="font-size: 0.9rem;">Filter:</strong>
                        <button onclick="filterFormats('all')" class="format-filter-btn active" data-type="all" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem;">
                            All (${formats.length})
                        </button>
                        ${types.map(type => `
                            <button onclick="filterFormats('${type}')" class="format-filter-btn" data-type="${type}" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; text-transform: capitalize;">
                                ${type.replace(/_/g, ' ')} (${formats.filter(f => f.type === type).length})
                            </button>
                        `).join('')}
                    </div>
                    <div id="formats-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                `;

                formats.forEach((format, index) => {
                    const dimensions = format.renders?.[0]?.dimensions;
                    const width = dimensions?.width || dimensions?.max_width;
                    const height = dimensions?.height || dimensions?.max_height;
                    const isResponsive = dimensions?.min_width || dimensions?.min_height;

                    html += `
                        <div class="format-card" data-type="${format.type || 'unknown'}" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;" onclick="showFormatDetails(${index}, ${JSON.stringify(format).replace(/"/g, '&quot;')})">
                            ${format.preview_image ? `
                                <div style="width: 100%; height: 200px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <img src="${format.preview_image}" alt="${format.name}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<div style=&quot;color: #999; font-size: 3rem;&quot;>üé®</div>'">
                                </div>
                            ` : `
                                <div style="width: 100%; height: 200px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #999; font-size: 3rem;">
                                    üé®
                                </div>
                            `}
                            <div style="padding: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #111;">${format.name || format.format_id || 'Unnamed Format'}</div>
                                ${width && height ? `
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                                        üìê ${isResponsive ? 'Responsive: ' : ''}${width}√ó${height}${dimensions?.unit ? dimensions.unit : 'px'}
                                    </div>
                                ` : ''}
                                ${format.type ? `
                                    <div style="display: inline-block; padding: 0.25rem 0.5rem; background: #ede9fe; color: #5b21b6; border-radius: 4px; font-size: 0.75rem; text-transform: capitalize; margin-top: 0.5rem;">
                                        ${format.type.replace(/_/g, ' ')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';

                section.innerHTML = html;

                // Store formats for filtering
                window.currentFormats = formats;

            } catch (error) {
                section.innerHTML = `<div class="error-text">Failed to load formats: ${error.message}</div>`;
            }
        }

        function filterFormats(type) {
            const cards = document.querySelectorAll('.format-card');
            const buttons = document.querySelectorAll('.format-filter-btn');

            buttons.forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#667eea';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.borderColor = '#ddd';
                }
            });

            cards.forEach(card => {
                if (type === 'all' || card.dataset.type === type) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function showFormatDetails(index, format) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 2rem;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            const dimensions = format.renders?.[0]?.dimensions;
            const width = dimensions?.width || dimensions?.max_width;
            const height = dimensions?.height || dimensions?.max_height;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 800px; max-height: 90vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                    <div style="position: sticky; top: 0; background: white; border-bottom: 1px solid #e5e7eb; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.3rem;">${format.name || format.format_id}</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        ${format.preview_image ? `
                            <div style="margin-bottom: 1.5rem; text-align: center;">
                                <img src="${format.preview_image}" alt="${format.name}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            </div>
                        ` : ''}
                        ${format.description ? `<p style="color: #666; margin-bottom: 1.5rem;">${format.description}</p>` : ''}
                        <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                            ${format.format_id ? `<div><strong>Format ID:</strong> <code style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">${format.format_id}</code></div>` : ''}
                            ${format.type ? `<div><strong>Type:</strong> <span style="text-transform: capitalize;">${format.type.replace(/_/g, ' ')}</span></div>` : ''}
                            ${width && height ? `<div><strong>Dimensions:</strong> ${width}√ó${height}${dimensions?.unit || 'px'}</div>` : ''}
                            ${dimensions?.min_width || dimensions?.min_height ? `<div><strong>Responsive:</strong> Yes (${dimensions.min_width || 0}√ó${dimensions.min_height || 0} to ${dimensions.max_width || width}√ó${dimensions.max_height || height})</div>` : ''}
                        </div>
                        ${format.example_url ? `
                            <a href="${format.example_url}" target="_blank" style="display: inline-block; padding: 0.75rem 1.5rem; background: #667eea; color: white; text-decoration: none; border-radius: 6px; margin-top: 1rem;">
                                View Examples & Demos ‚Üí
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
